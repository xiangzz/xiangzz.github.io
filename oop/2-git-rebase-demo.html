<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Git 变基操作演示</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Montserrat:wght@400;600;700&family=Georgia:wght@400&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lato', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            line-height: 1.7;
            background-color: #fdfdfd;
            color: #4a4a4a;
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 900px;
            background-color: #ffffff;
            border-radius: 4px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.07);
            border: 1px solid #e9ecef;
            padding: 30px;
        }
        /* 标题和按钮容器 */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        h1 {
            text-align: left;
            color: #2c3e50;
            font-family: 'Georgia', 'Times New Roman', Times, serif;
            font-size: 2.8rem;
            font-weight: normal;
            position: relative;
            padding-bottom: 1rem;
            margin: 0;
            flex: 1;
        }
        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 80px;
            height: 2px;
            background-color: #af9a7d;
        }

        /* 控制和状态区 */
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        button {
            padding: 10px 20px;
            border: 1px solid #2c3e50;
            border-radius: 4px;
            background-color: #2c3e50;
            color: #ffffff;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        button:hover {
            background-color: #af9a7d;
            border-color: #af9a7d;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        
        button:disabled {
            background-color: #bdc3c7;
            border-color: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        input, select {
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Lato', sans-serif;
            background-color: #ffffff;
            color: #4a4a4a;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #af9a7d;
            box-shadow: 0 0 0 0.25rem rgba(175, 154, 125, 0.25);
        }
        
        #next-step-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #next-step-btn:hover {
            background-color: #2980b9;
        }
        #next-step-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .status {
            background-color: #ecf0f1;
            border-left: 5px solid #3498db;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        #command-display {
            font-family: 'Courier New', Courier, monospace;
            background-color: #2c3e50;
            color: #f1c40f;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        #explanation {
            margin-top: 10px;
            color: #555;
        }

        /* Git图形样式 */
        .git-graph {
            background-color: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 30px;
            margin: 30px 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .commit {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: #2c3e50;
            position: absolute;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid #ffffff;
            box-shadow: 0 0 0 2px #2c3e50, 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .commit:hover {
            transform: scale(1.2);
            z-index: 10;
            background-color: #af9a7d;
            box-shadow: 0 0 0 2px #af9a7d, 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .commit-line {
            position: absolute;
            background-color: #bdc3c7;
            height: 3px;
            border-radius: 1.5px;
        }
        
        .branch-line {
            position: absolute;
            background-color: #2c3e50;
            width: 3px;
            border-radius: 1.5px;
        }
        
        .branch-label {
            position: absolute;
            background-color: #ffffff;
            border: 2px solid #2c3e50;
            border-radius: 4px;
            padding: 4px 12px;
            font-size: 13px;
            color: #2c3e50;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .branch-label:hover {
            background-color: #2c3e50;
            color: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .branch-label.current-branch {
            background-color: #af9a7d;
            border-color: #af9a7d;
            color: #ffffff;
            font-weight: 700;
            box-shadow: 0 3px 8px rgba(175, 154, 125, 0.3);
        }

        /* 图形化展示区 */
        #graph-container {
            width: 100%;
            height: 250px;
            margin-bottom: 20px;
        }
        .commit-circle {
            transition: all 0.5s ease;
        }
        .commit-label {
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
        }
        .main-label { background-color: #2ecc71; color: white; }
        .feature-label { background-color: #e67e22; color: white; }
        .head-label {
            border: 2px dashed #c0392b;
            color: #c0392b;
            padding: 1px 5px;
        }
        .rebase-highlight {
            stroke: #e74c3c;
            stroke-width: 3;
            stroke-dasharray: 5,5;
            animation: dash 1s linear infinite;
        }
        @keyframes dash {
            to {
                stroke-dashoffset: -10;
            }
        }

        /* 代码模拟区 */
        .code-view {
            display: flex;
            gap: 20px;
            justify-content: space-around;
        }
        .branch-code {
            width: 48%;
        }
        .branch-code h3 {
            text-align: center;
            margin-bottom: 10px;
        }
        textarea {
            width: 100%;
            height: 200px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            resize: none;
        }
        textarea:disabled {
            background-color: #f0f0f0;
            color: #888;
        }
        
        /* 信息面板 */
        #info-panel {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 20px;
            margin-top: 30px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            white-space: pre-wrap;
            color: #4a4a4a;
            line-height: 1.6;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        
        /* 步骤说明 */
        .step-description {
            background-color: #ffffff;
            border-left: 4px solid #af9a7d;
            padding: 20px;
            margin: 30px 0;
            border-radius: 0 4px 4px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-top: 1px solid #e9ecef;
            border-right: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
        }
        
        .step-description h3 {
            margin-top: 0;
            color: #2c3e50;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 1.3rem;
        }
        
        .step-description p {
            color: #4a4a4a;
            margin-bottom: 0;
            line-height: 1.6;
        }

        /* 对比区域 */
        .comparison {
            display: flex;
            gap: 20px;
            margin: 30px 0;
        }
        .comparison-item {
            flex: 1;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 20px;
            background-color: #ffffff;
        }
        .comparison-item h4 {
            margin-top: 0;
            color: #2c3e50;
            text-align: center;
            font-family: 'Montserrat', sans-serif;
        }
        .before { border-left: 4px solid #e74c3c; }
        .after { border-left: 4px solid #27ae60; }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .controls {
                align-self: stretch;
                justify-content: center;
            }
            
            .comparison {
                flex-direction: column;
            }
            
            .code-view {
                flex-direction: column;
            }
            
            .branch-code {
                width: 100%;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-container">
        <h1>Git 变基操作演示流程</h1>
        <div class="controls">
            <button id="next-step-btn">开始演示</button>
        </div>
    </div>

    <div class="status">
        <pre id="command-display">等待操作...</pre>
        <p id="explanation">点击"开始演示"按钮，一步步跟随 Git rebase 的操作流程。</p>
    </div>

    <div id="graph-container">
        <svg width="100%" height="100%" id="git-graph"></svg>
    </div>

    <div class="comparison" id="comparison-section" style="display: none;">
        <div class="comparison-item before">
            <h4>变基前的提交历史</h4>
            <div id="before-history"></div>
        </div>
        <div class="comparison-item after">
            <h4>变基后的提交历史</h4>
            <div id="after-history"></div>
        </div>
    </div>

    <div class="code-view">
        <div class="branch-code">
            <h3 id="main-code-title">main 分支 (文件: feature.txt)</h3>
            <textarea id="main-code" disabled></textarea>
        </div>
        <div class="branch-code">
            <h3 id="feature-code-title">feature 分支 (文件: feature.txt)</h3>
            <textarea id="feature-code" disabled></textarea>
        </div>
    </div>

    <div id="info-panel"></div>
</div>

<script>
    const steps = [
        {
            command: "git init",
            explanation: "初始化一个新的 Git 仓库。我们有了一个空的 main 分支。",
            action: () => {
                drawCommit('c1', 50, 'C1');
                drawBranchLabel('main', 'c1');
                drawHeadLabel('main');
                updateCode('main', '项目初始化');
                setActiveBranch('main');
                updateInfoPanel('初始化仓库，创建第一个提交。');
            }
        },
        {
            command: "git commit -m 'feat: 添加基础功能'",
            explanation: "在 main 分支上进行第一次提交。我们添加了基础功能。",
            action: () => {
                drawCommit('c2', 150, 'C2', 'c1');
                moveBranchLabel('main', 'c2');
                drawHeadLabel('main');
                updateCode('main', '项目初始化\n添加基础功能');
                updateInfoPanel('在 main 分支上添加基础功能。');
            }
        },
        {
            command: "git branch feature",
            explanation: "基于当前 main 分支的最新提交(C2)创建一个新的 feature 分支。",
            action: () => {
                drawBranchLabel('feature', 'c2');
                updateCode('feature', document.getElementById('main-code').value);
                updateInfoPanel('创建 feature 分支，基于 C2 提交。');
            }
        },
        {
            command: "git checkout feature",
            explanation: "切换到 feature 分支。现在我们的所有操作都将在 feature 分支上进行。",
            action: () => {
                drawHeadLabel('feature');
                setActiveBranch('feature');
                updateInfoPanel('切换到 feature 分支开始开发新功能。');
            }
        },
        {
            command: "git commit -m 'feat: 开发功能A'",
            explanation: "在 feature 分支上进行第一次提交。我们添加了\"功能A\"。注意，main 分支保持不变。",
            action: () => {
                drawCommit('c3', 250, 'C3', 'c2', 'feature');
                moveBranchLabel('feature', 'c3');
                drawHeadLabel('feature');
                updateCode('feature', '项目初始化\n添加基础功能\n开发功能A');
                updateInfoPanel('在 feature 分支上开发功能A。');
            }
        },
        {
            command: "git commit -m 'feat: 开发功能B'",
            explanation: "在 feature 分支上再次提交，添加了\'功能B\'。feature 分支现在领先 main 分支两个提交。",
            action: () => {
                drawCommit('c4', 350, 'C4', 'c3', 'feature');
                moveBranchLabel('feature', 'c4');
                drawHeadLabel('feature');
                updateCode('feature', '项目初始化\n添加基础功能\n开发功能A\n开发功能B');
                updateInfoPanel('继续在 feature 分支上开发功能B。');
            }
        },
        {
            command: "git checkout main",
            explanation: "切换回 main 分支。注意代码区和 HEAD 指针的变化。",
            action: () => {
                drawHeadLabel('main');
                setActiveBranch('main');
                updateInfoPanel('切换回 main 分支。');
            }
        },
        {
            command: "git commit -m 'hotfix: 紧急修复'",
            explanation: "在 main 分支上进行了一次提交，模拟线上紧急修复。现在 main 和 feature 分支有了各自不同的提交，它们\"分叉\"了。",
            action: () => {
                drawCommit('c5', 250, 'C5', 'c2', 'main');
                moveBranchLabel('main', 'c5');
                drawHeadLabel('main');
                updateCode('main', '项目初始化\n添加基础功能\n紧急修复');
                updateInfoPanel('在 main 分支上进行紧急修复，现在两个分支分叉了。');
                showComparison();
            }
        },
        {
            command: "git checkout feature",
            explanation: "切换到 feature 分支，准备进行 rebase 操作。",
            action: () => {
                drawHeadLabel('feature');
                setActiveBranch('feature');
                updateInfoPanel('切换到 feature 分支，准备进行变基操作。');
            }
        },
        {
            command: "git rebase main",
            explanation: "开始 rebase 操作！Git 会将 feature 分支的提交(C3, C4)重新应用到 main 分支的最新提交(C5)之上。",
            action: () => {
                highlightRebaseCommits();
                updateInfoPanel('开始变基操作：将 feature 分支的提交重新应用到 main 分支之上...');
                document.getElementById('next-step-btn').innerText = "应用第一个提交";
            }
        },
        {
            command: "应用 C3' (feat: 开发功能A)",
            explanation: "Git 创建了一个新的提交 C3'，它包含与原 C3 相同的更改，但基于 C5。注意提交 ID 会改变！",
            action: () => {
                removeHighlight();
                drawCommit('c3p', 350, "C3'", 'c5', 'feature');
                updateCode('feature', '项目初始化\n添加基础功能\n紧急修复\n开发功能A');
                updateInfoPanel('应用第一个提交：C3 -> C3\' (基于新的基础提交 C5)');
                document.getElementById('next-step-btn').innerText = "应用第二个提交";
            }
        },
        {
            command: "应用 C4' (feat: 开发功能B)",
            explanation: "Git 创建了另一个新的提交 C4'，它包含与原 C4 相同的更改，但基于 C3'。",
            action: () => {
                drawCommit('c4p', 450, "C4'", 'c3p', 'feature');
                moveBranchLabel('feature', 'c4p');
                drawHeadLabel('feature');
                updateCode('feature', '项目初始化\n添加基础功能\n紧急修复\n开发功能A\n开发功能B');
                updateInfoPanel('应用第二个提交：C4 -> C4\' (基于 C3\')');
                document.getElementById('next-step-btn').innerText = "完成变基";
            }
        },
        {
            command: "变基完成",
            explanation: "Rebase 操作完成！现在 feature 分支的历史是线性的，看起来就像是基于最新的 main 分支开发的。原来的 C3 和 C4 提交已经被新的 C3' 和 C4' 替代。",
            action: () => {
                fadeOldCommits();
                updateAfterComparison();
                updateInfoPanel('变基完成！提交历史现在是线性的，feature 分支看起来像是基于最新的 main 分支开发的。\n\n注意：原始的 C3 和 C4 提交已经被新的 C3\' 和 C4\' 替代。');
                document.getElementById('next-step-btn').innerText = "重新开始";
            }
        }
    ];

    let currentStep = -1;
    const btn = document.getElementById('next-step-btn');
    const commandDisplay = document.getElementById('command-display');
    const explanationDisplay = document.getElementById('explanation');
    const svg = document.getElementById('git-graph');
    const infoPanel = document.getElementById('info-panel');
    const ns = "http://www.w3.org/2000/svg";

    const commitCoords = {};

    function reset() {
        currentStep = -1;
        svg.innerHTML = '';
        Object.keys(commitCoords).forEach(key => delete commitCoords[key]);
        commandDisplay.innerText = "等待操作...";
        explanationDisplay.innerText = "点击\"开始演示\"按钮，一步步跟随 Git rebase 的操作流程。";
        btn.innerText = "开始演示";
        btn.disabled = false;
        updateCode('main', '');
        updateCode('feature', '');
        setActiveBranch(null);
        infoPanel.innerText = '';
        document.getElementById('comparison-section').style.display = 'none';
        document.getElementById('main-code-title').innerText = "main 分支 (文件: feature.txt)";
        document.getElementById('feature-code-title').innerText = "feature 分支 (文件: feature.txt)";
    }

    btn.addEventListener('click', () => {
        currentStep++;
        if (currentStep >= steps.length) {
            reset();
            return;
        }

        const step = steps[currentStep];
        commandDisplay.innerText = step.command;
        explanationDisplay.innerText = step.explanation;
        step.action();

        if (currentStep === steps.length - 1) {
            btn.innerText = "重新开始";
        } else if (currentStep >= 9 && currentStep <= 11) {
            // Button text is updated inside the action for rebase steps
        } else {
            btn.innerText = "下一步";
        }
    });

    function drawCommit(id, x, label, parentId, branch = 'main') {
        const y = branch === 'main' ? 50 : 120;
        commitCoords[id] = { x, y, branch };

        // Draw line(s) to parent(s)
        if (parentId) {
            const parents = Array.isArray(parentId) ? parentId : [parentId];
            parents.forEach(pId => {
                const pCoords = commitCoords[pId];
                const line = document.createElementNS(ns, 'line');
                line.setAttribute('id', `line-${id}-${pId}`);
                line.setAttribute('x1', pCoords.x);
                line.setAttribute('y1', pCoords.y);
                line.setAttribute('x2', x);
                line.setAttribute('y2', y);
                line.setAttribute('stroke', '#555');
                line.setAttribute('stroke-width', 2);
                svg.appendChild(line);
            });
        }
        
        // Draw circle
        const circle = document.createElementNS(ns, 'circle');
        circle.setAttribute('id', `circle-${id}`);
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y);
        circle.setAttribute('r', 15);
        circle.setAttribute('fill', branch === 'main' ? '#2ecc71' : '#e67e22');
        circle.setAttribute('stroke', '#2c3e50');
        circle.setAttribute('stroke-width', 3);
        circle.classList.add('commit-circle');
        svg.appendChild(circle);

        // Draw label
        const text = document.createElementNS(ns, 'text');
        text.setAttribute('id', `text-${id}`);
        text.setAttribute('x', x);
        text.setAttribute('y', y + 5);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', 'white');
        text.classList.add('commit-label');
        text.textContent = label;
        svg.appendChild(text);
    }

    function drawBranchLabel(branchName, commitId) {
        const coords = commitCoords[commitId];
        const foreignObject = document.createElementNS(ns, 'foreignObject');
        foreignObject.setAttribute('id', `label-${branchName}`);
        foreignObject.setAttribute('x', coords.x - 30);
        foreignObject.setAttribute('y', coords.y + 25);
        foreignObject.setAttribute('width', 70);
        foreignObject.setAttribute('height', 30);
        
        const span = document.createElement('span');
        span.className = `branch-label ${branchName}-label`;
        span.textContent = branchName;
        
        foreignObject.appendChild(span);
        svg.appendChild(foreignObject);
    }

    function moveBranchLabel(branchName, commitId) {
        const coords = commitCoords[commitId];
        const label = document.getElementById(`label-${branchName}`);
        if (label) {
            label.setAttribute('x', coords.x - 30);
            label.setAttribute('y', coords.y + 25);
        }
    }

    function drawHeadLabel(branchName) {
        // Remove existing HEAD label
        const existingHead = document.getElementById('head-label');
        if (existingHead) {
            existingHead.remove();
        }

        const branchLabel = document.getElementById(`label-${branchName}`);
        if (branchLabel) {
            const coords = {
                x: parseInt(branchLabel.getAttribute('x')) + 35,
                y: parseInt(branchLabel.getAttribute('y')) - 10
            };
            
            const foreignObject = document.createElementNS(ns, 'foreignObject');
            foreignObject.setAttribute('id', 'head-label');
            foreignObject.setAttribute('x', coords.x);
            foreignObject.setAttribute('y', coords.y);
            foreignObject.setAttribute('width', 50);
            foreignObject.setAttribute('height', 25);
            
            const span = document.createElement('span');
            span.className = 'head-label';
            span.textContent = 'HEAD';
            
            foreignObject.appendChild(span);
            svg.appendChild(foreignObject);
        }
    }

    function updateCode(branch, content) {
        document.getElementById(`${branch}-code`).value = content;
    }

    function setActiveBranch(branch) {
        // Remove active class from all branch labels
        document.querySelectorAll('.branch-label').forEach(label => {
            label.classList.remove('current-branch');
        });
        
        // Add active class to current branch
        if (branch) {
            const branchLabel = document.querySelector(`.${branch}-label`);
            if (branchLabel) {
                branchLabel.classList.add('current-branch');
            }
        }
    }

    function updateInfoPanel(text) {
        infoPanel.innerText = text;
    }

    function showComparison() {
        document.getElementById('comparison-section').style.display = 'flex';
        document.getElementById('before-history').innerHTML = `
            <div style="font-family: 'Courier New', monospace; font-size: 12px;">
                C1 ← C2 ← C5 (main)<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;↖<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C3 ← C4 (feature)
            </div>
        `;
    }

    function updateAfterComparison() {
        document.getElementById('after-history').innerHTML = `
            <div style="font-family: 'Courier New', monospace; font-size: 12px;">
                C1 ← C2 ← C5 ← C3' ← C4' (feature)<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;↑<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(main)
            </div>
        `;
    }

    function highlightRebaseCommits() {
        const c3Circle = document.getElementById('circle-c3');
        const c4Circle = document.getElementById('circle-c4');
        if (c3Circle) c3Circle.classList.add('rebase-highlight');
        if (c4Circle) c4Circle.classList.add('rebase-highlight');
    }

    function removeHighlight() {
        document.querySelectorAll('.rebase-highlight').forEach(el => {
            el.classList.remove('rebase-highlight');
        });
    }

    function fadeOldCommits() {
        const c3Circle = document.getElementById('circle-c3');
        const c4Circle = document.getElementById('circle-c4');
        const c3Text = document.getElementById('text-c3');
        const c4Text = document.getElementById('text-c4');
        const c3Line = document.getElementById('line-c3-c2');
        const c4Line = document.getElementById('line-c4-c3');
        
        [c3Circle, c4Circle, c3Text, c4Text, c3Line, c4Line].forEach(el => {
            if (el) {
                el.style.opacity = '0.3';
                el.style.filter = 'grayscale(100%)';
            }
        });
    }
</script>

</body>
</html>