<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“¶è¡Œè´¦æˆ·å¹¶å‘å­˜æ¬¾æ¼”ç¤º</title>
    <link rel="stylesheet" href="./css/style.css">
    <style>
        /* å…¨å±€è¦†ç›– */
        html, body {
            height: auto !important;
            overflow: visible !important;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { color: #2c3e50; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 30px; text-align: center; max-width: 800px; font-size: 1.1rem;}

        .main-stage {
            display: flex;
            gap: 40px;
            align-items: flex-start;
            justify-content: center;
            margin-bottom: 30px;
            width: 100%;
            max-width: 1000px;
        }

        /* çº¿ç¨‹å¡ç‰‡ */
        .thread-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            padding: 20px;
            width: 280px;
            border-top: 5px solid #bdc3c7;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .thread-card.active {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        #card-a { border-top-color: #3498db; }
        #card-b { border-top-color: #9b59b6; }

        .thread-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .avatar { width: 36px; height: 36px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9rem; }
        #card-a .avatar { background: #3498db; }
        #card-b .avatar { background: #9b59b6; }

        .memory-box {
            background: #f8f9fa;
            border: 2px dashed #cbd5e0;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .memory-label { font-size: 0.8rem; color: #7f8c8d; display: block; margin-bottom: 5px; }
        .memory-val { font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.5rem; color: #2c3e50; }

        .code-block {
            background: #282c34;
            color: #abb2bf;
            padding: 10px;
            border-radius: 6px;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        
        .code-line { padding: 4px 8px; border-radius: 4px; margin-bottom: 2px; }
        .code-line.active { background: #3e4451; color: #fff; border-left: 4px solid #61afef; }

        /* ä¸»å†…å­˜åŒºåŸŸ */
        .shared-memory {
            background: #fff;
            border-radius: 12px;
            padding: 30px;
            width: 220px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 2px solid #2c3e50;
            position: relative;
            align-self: center;
        }
        
        .shared-title { font-weight: bold; color: #2c3e50; margin-bottom: 15px; font-size: 1.1rem; }
        .shared-val { font-size: 2.5rem; font-weight: bold; color: #27ae60; font-family: 'Courier New', monospace; }
        .shared-icon { font-size: 2rem; margin-bottom: 10px; display: block; }

        /* æ§åˆ¶åŒº - è¦†ç›–å…¨å±€ style.css çš„ absolute å®šä½ */
        .controls {
            position: relative !important;
            bottom: auto !important;
            right: auto !important;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 30px;
            width: 100%;
            justify-content: center;
            max-width: 800px;
        }

        button {
            padding: 12px 24px;
            font-size: 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
            transition: all 0.2s;
            font-family: 'Segoe UI', sans-serif;
            font-weight: 600;
        }

        .btn-step-a { background: #3498db; }
        .btn-step-a:hover { background: #2980b9; }
        
        .btn-step-b { background: #9b59b6; }
        .btn-step-b:hover { background: #8e44ad; }

        .btn-auto { background: #e67e22; }
        .btn-auto:hover { background: #d35400; }
        
        .btn-reset { background: #95a5a6; }
        .btn-reset:hover { background: #7f8c8d; }

        button:disabled { background: #ccc; cursor: not-allowed; opacity: 0.7; }

        /* å†å²è®°å½• */
        .history-log {
            width: 100%;
            max-width: 800px;
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .log-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
        }
        .log-item:last-child { border-bottom: none; }
        .log-action { font-weight: bold; }
        .log-action.A { color: #3498db; }
        .log-action.B { color: #9b59b6; }
        .log-conflict { background: #ffebee; color: #c62828; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 10px; }

    </style>
</head>
<body>

    <h1>å¹¶å‘å®‰å…¨æ¼”ç¤ºï¼šé“¶è¡Œè´¦æˆ·å­˜æ¬¾</h1>
    <p class="subtitle">
        <strong>åœºæ™¯æè¿°ï¼š</strong> è´¦æˆ·åˆå§‹ä½™é¢ä¸º 1000 å…ƒã€‚ä¸ˆå¤« (Thread A) å’Œ å¦»å­ (Thread B) åŒæ—¶åœ¨ä¸åŒçš„æŸœå°å¾€è¯¥è´¦æˆ·å­˜å…¥ 100 å…ƒã€‚<br>
        å¦‚æœæ“ä½œæ­£å¸¸ï¼Œæœ€ç»ˆä½™é¢åº”ä¸º 1200 å…ƒã€‚ä½†å¦‚æœå‘ç”Ÿå¹¶å‘é—®é¢˜ï¼Œ100 å…ƒå¯èƒ½ä¼šâ€œå‡­ç©ºæ¶ˆå¤±â€ã€‚
    </p>

    <div class="main-stage">
        <!-- çº¿ç¨‹ A -->
        <div class="thread-card" id="card-a">
            <div class="thread-title">
                <div class="avatar">å¤«</div> ä¸ˆå¤« (Thread A)
            </div>
            <div class="memory-box">
                <span class="memory-label">æ‰‹é‡Œæ‹¿ç€çš„å•æ® (å·¥ä½œå†…å­˜)</span>
                <div class="memory-val" id="local-a">?</div>
            </div>
            <div class="code-block">
                <div class="code-line" id="code-a-0">// å‡†å¤‡å­˜æ¬¾</div>
                <div class="code-line" id="code-a-1">1. READ: æŸ¥è¯¢ä½™é¢</div>
                <div class="code-line" id="code-a-2">2. MODIFY: è®¡ç®—æ–°ä½™é¢ (+100)</div>
                <div class="code-line" id="code-a-3">3. WRITE: æ›´æ–°è´¦æˆ·</div>
            </div>
        </div>

        <!-- å…±äº«å†…å­˜ -->
        <div class="shared-memory">
            <span class="shared-icon">ğŸ¦</span>
            <div class="shared-title">é“¶è¡Œè´¦æˆ·ä½™é¢<br>(Main Memory)</div>
            <div class="shared-val" id="main-val">1000</div>
        </div>

        <!-- çº¿ç¨‹ B -->
        <div class="thread-card" id="card-b">
            <div class="thread-title">
                <div class="avatar">å¦»</div> å¦»å­ (Thread B)
            </div>
            <div class="memory-box">
                <span class="memory-label">æ‰‹é‡Œæ‹¿ç€çš„å•æ® (å·¥ä½œå†…å­˜)</span>
                <div class="memory-val" id="local-b">?</div>
            </div>
            <div class="code-block">
                <div class="code-line" id="code-b-0">// å‡†å¤‡å­˜æ¬¾</div>
                <div class="code-line" id="code-b-1">1. READ: æŸ¥è¯¢ä½™é¢</div>
                <div class="code-line" id="code-b-2">2. MODIFY: è®¡ç®—æ–°ä½™é¢ (+100)</div>
                <div class="code-line" id="code-b-3">3. WRITE: æ›´æ–°è´¦æˆ·</div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn-step-a" id="btn-a" onclick="step('A')">ä¸ˆå¤«æ‰§è¡Œä¸€æ­¥</button>
        <button class="btn-step-b" id="btn-b" onclick="step('B')">å¦»å­æ‰§è¡Œä¸€æ­¥</button>
        <div style="width: 20px;"></div>
        <button class="btn-auto" onclick="playScenario()">æ¼”ç¤ºâ€œé’±æ²¡äº†â€ (æ•°æ®ä¸¢å¤±)</button>
        <button class="btn-reset" onclick="reset()">é‡ç½®</button>
    </div>

    <div class="history-log">
        <h4 style="margin-top:0; border-bottom:1px solid #ddd; padding-bottom:10px;">æ“ä½œæ—¥å¿—</h4>
        <div id="log-container">
            <div class="log-item" style="color:#999; font-style:italic;">è¯·ç‚¹å‡»æŒ‰é’®å¼€å§‹æ“ä½œ...</div>
        </div>
    </div>

    <script>
        // çŠ¶æ€å®šä¹‰
        const INITIAL_BALANCE = 1000;
        const DEPOSIT_AMOUNT = 100;
        let mainMemory = INITIAL_BALANCE;
        
        // çº¿ç¨‹çŠ¶æ€å¯¹è±¡
        const threads = {
            A: { step: 0, local: null, elLocal: 'local-a', elCard: 'card-a', completedRuns: 0 },
            B: { step: 0, local: null, elLocal: 'local-b', elCard: 'card-b', completedRuns: 0 }
        };

        function updateUI() {
            document.getElementById('main-val').innerText = mainMemory;
            
            ['A', 'B'].forEach(t => {
                const thread = threads[t];
                // æ›´æ–°å·¥ä½œå†…å­˜æ˜¾ç¤º
                const localText = thread.local === null ? "?" : thread.local;
                document.getElementById(thread.elLocal).innerText = localText;
                
                // æ›´æ–°ä»£ç é«˜äº®
                for(let i=0; i<=3; i++) {
                    const line = document.getElementById(`code-${t.toLowerCase()}-${i}`);
                    if (i === thread.step) line.classList.add('active');
                    else line.classList.remove('active');
                }
                
                // æ›´æ–°å¡ç‰‡æ¿€æ´»çŠ¶æ€
                const card = document.getElementById(thread.elCard);
                if (thread.step > 0) card.classList.add('active');
                else card.classList.remove('active');
            });
        }

        function step(threadName) {
            const t = threads[threadName];
            const role = threadName === 'A' ? 'ä¸ˆå¤«' : 'å¦»å­';
            
            // çŠ¶æ€æœºæµè½¬
            if (t.step === 0) {
                // å‡†å¤‡å¼€å§‹
                t.step = 1;
                // Step 1: READ
                t.local = mainMemory;
                addLog(threadName, `${role} æŸ¥è¯¢ä½™é¢ï¼Œçœ‹åˆ°æ˜¯ ${mainMemory}`);
            } 
            else if (t.step === 1) {
                // Step 2: MODIFY
                t.step = 2;
                t.local = t.local + DEPOSIT_AMOUNT;
                addLog(threadName, `${role} åœ¨å•æ®ä¸Šè®¡ç®—æ–°ä½™é¢ï¼š${t.local - DEPOSIT_AMOUNT} + ${DEPOSIT_AMOUNT} = ${t.local}`);
            } 
            else if (t.step === 2) {
                // Step 3: WRITE
                t.step = 3;
                
                // å†²çªæ£€æµ‹ï¼šå¦‚æœå†™å…¥æ—¶ï¼Œä¸»å†…å­˜çš„å€¼æ¯”æˆ‘â€œè¯»å…¥â€æ—¶çš„å€¼å¤§ï¼ˆè¯´æ˜æœŸé—´æœ‰äººæ”¹è¿‡ï¼‰ï¼Œ
                // æˆ–è€…æ›´ç®€å•çš„åˆ¤æ–­ï¼šæˆ‘çš„å†™å…¥å€¼ <= ä¸»å†…å­˜å½“å‰å€¼ï¼ˆåœ¨è¿™ä¸ªåªå¢ä¸å‡çš„åœºæ™¯ä¸‹ï¼Œè¿™æ„å‘³æˆ‘åšçš„åŠŸç™½è´¹äº†æˆ–è€…è¦†ç›–äº†åˆ«äººçš„å¤§å€¼ï¼‰
                // å‡†ç¡®é€»è¾‘ï¼šåœ¨è¿™ä¸ªåœºæ™¯ï¼Œå¦‚æœå‘ç”Ÿè¦†ç›–ï¼Œä¸»å­˜å€¼ä¸ä¼šå˜æˆ 1200ï¼Œè€Œæ˜¯åœç•™åœ¨ 1100ã€‚
                
                let conflict = false;
                // å¦‚æœå†™å…¥åï¼Œä¸»å­˜çš„å€¼æ²¡æœ‰å¢åŠ ï¼ˆæ¯”å¦‚æœ¬æ¥å°±æ˜¯ 1100ï¼Œæˆ‘å†™è¿›å»è¿˜æ˜¯ 1100ï¼‰ï¼Œè¯´æ˜è¦†ç›–äº†åˆ«äººçš„æ“ä½œ
                // æˆ–è€…ï¼šå¦‚æœå†™å…¥å‰ï¼Œä¸»å­˜å·²ç»è¢«ä¿®æ”¹è¿‡ï¼ˆä¸ç­‰äºæˆ‘æœ€åˆè¯»çš„å€¼ï¼‰
                // è¿™é‡Œæˆ‘ä»¬ç®€å•åˆ¤æ–­ç»“æœï¼šå¦‚æœæˆ‘å†™å®Œï¼Œä¸»å­˜ä¸æ˜¯ 1200ï¼ˆä¸”æˆ‘æ˜¯åæ‰§è¡Œçš„é‚£ä¸ªï¼‰ï¼Œé‚£å°±æ˜¯å‡ºäº‹äº†ã€‚
                // ä¸ºäº†æ¼”ç¤ºç›´è§‚ï¼Œæˆ‘ä»¬åœ¨ log é‡Œç›´æ¥æ ‡è®°â€œè¦†ç›–â€ã€‚
                
                // ç®€å•çš„åˆ¤å®šé€»è¾‘ï¼šå¦‚æœ mainMemory å·²ç»ä¸ç­‰äºæˆ‘å½“åˆè¯»å–çš„åŸºç¡€å€¼ï¼ˆt.local - 100ï¼‰ï¼Œè¯´æ˜ä¸­é—´æœ‰äººæ’é˜Ÿä¿®æ”¹äº†
                if (mainMemory !== (t.local - DEPOSIT_AMOUNT)) {
                    conflict = true;
                }
                
                mainMemory = t.local;
                
                if (conflict) {
                    addLog(threadName, `${role} å°† ${mainMemory} å†™å…¥ç³»ç»Ÿ (è¦†ç›–äº†ä¹‹å‰çš„ä¿®æ”¹ï¼)`, true);
                } else {
                    addLog(threadName, `${role} å°† ${mainMemory} å†™å…¥ç³»ç»Ÿ`);
                }
                
                // è¿™ä¸€è½®ç»“æŸ
                setTimeout(() => {
                    t.step = 0;
                    t.local = null;
                    t.completedRuns++;
                    updateUI();
                }, 800); 
            }

            updateUI();
        }

        function addLog(thread, msg, isConflict = false) {
            const container = document.getElementById('log-container');
            if (container.children[0] && container.children[0].style.fontStyle === 'italic') {
                container.innerHTML = '';
            }
            
            const div = document.createElement('div');
            div.className = 'log-item';
            
            const spanAction = document.createElement('span');
            spanAction.className = `log-action ${thread}`;
            spanAction.innerText = `[${thread === 'A' ? 'ä¸ˆå¤«' : 'å¦»å­'}]`;
            
            const spanMsg = document.createElement('span');
            spanMsg.innerText = msg;
            
            if (isConflict) {
                const badge = document.createElement('span');
                badge.className = 'log-conflict';
                badge.innerText = 'è¦†ç›–å†™ï¼ä¸¢é’±äº†ï¼';
                spanMsg.appendChild(badge);
            }

            div.appendChild(spanAction);
            div.appendChild(spanMsg);
            container.prepend(div);
        }

        function reset() {
            mainMemory = INITIAL_BALANCE;
            threads.A = { step: 0, local: null, elLocal: 'local-a', elCard: 'card-a', completedRuns: 0 };
            threads.B = { step: 0, local: null, elLocal: 'local-b', elCard: 'card-b', completedRuns: 0 };
            document.getElementById('log-container').innerHTML = '<div class="log-item" style="color:#999; font-style:italic;">è¯·ç‚¹å‡»æŒ‰é’®å¼€å§‹æ“ä½œ...</div>';
            updateUI();
        }

        // è‡ªåŠ¨æ¼”ç¤ºå‰§æœ¬
        async function playScenario() {
            reset();
            await delay(500);
            
            // å‰§æœ¬ï¼š
            // 1. ä¸ˆå¤«æŸ¥è¯¢ä½™é¢ (1000)
            step('A'); 
            await delay(1200);
            
            // 2. å¦»å­ä¹ŸæŸ¥è¯¢ä½™é¢ (1000) -> æ­¤æ—¶å¥¹ä¸çŸ¥é“ä¸ˆå¤«ä¹Ÿè¦å­˜é’±
            step('B');
            await delay(1200);
            
            // 3. ä¸ˆå¤«è®¡ç®— (1100)
            step('A');
            await delay(1200);
            
            // 4. å¦»å­è®¡ç®— (1100)
            step('B');
            await delay(1200);
            
            // 5. ä¸ˆå¤«æäº¤ (è´¦æˆ·å˜ä¸º 1100)
            step('A');
            await delay(1200);
            
            // 6. å¦»å­æäº¤ (è´¦æˆ·å˜ä¸º 1100) -> ä¸ˆå¤«å­˜çš„é‚£ 100 å—è¢«è¦†ç›–äº†ï¼
            step('B');
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Init
        updateUI();

    </script>
</body>
</html>