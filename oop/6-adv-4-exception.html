<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Java异常机制详解</title>
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/hacker-cmd.css">
    <link rel="stylesheet" href="../prism/prism.css">
</head>

<body>

    <main id="presentation">
        <!-- Slide 1: Title -->
        <section class="slide title-slide active">
            <h1>异常机制</h1>
            <p>面向对象程序设计（Java）</p>
            <strong>掌握异常类型、抛出与处理、断言；编写更健壮的程序</strong>
        </section>

        <!-- 第一部分：异常基础概念 -->

        <!-- Slide 2: Why Exceptions -->
        <section class="slide">
            <div class="slide-content">
                <h2>为什么需要异常？</h2>
                <p>理想情况下，程序会按预期运行；现实中会遇到不可预料的输入与状态。异常用于在运行期<strong>报告问题</strong>，并提供<strong>优雅的处理</strong>路径。</p>
                <pre><code class="language-java">public static void main(String[] args) {
    test(1, 0);   // 当 b 为 0 时会怎样？
}
private static int test(int a, int b){
    return a / b; // 未进行判断，运行期可能抛出异常
}</code></pre>
                <p class="conclusion">异常是"程序遇到非正常情况时抛出的对象"，由JVM或我们手动抛出。<br>学会识别与处理它，程序就能在出错后继续有序运行。</p>
            </div>
        </section>

        <!-- Slide 3: Exception System Overview -->
        <section class="slide">
            <div class="slide-content">
                <h2>异常体系概览</h2>
                <img src="images/6-4-exception-types.png" alt="异常的三大类" style="width: 85%; margin: 15px auto;">
                <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                    <div style="text-align: center; width: 30%;">
                        <h4 style="color: #e74c3c;">Error（错误）</h4>
                        <p style="font-size: 0.9em;">严重系统问题，无法恢复<br>如：OutOfMemoryError</p>
                    </div>
                    <div style="text-align: center; width: 30%;">
                        <h4 style="color: #f39c12;">Checked Exception</h4>
                        <p style="font-size: 0.9em;">编译器强制处理<br>如：IOException</p>
                    </div>
                    <div style="text-align: center; width: 30%;">
                        <h4 style="color: #3498db;">RuntimeException</h4>
                        <p style="font-size: 0.9em;">编程逻辑错误<br>如：NullPointerException</p>
                    </div>
                </div>
                <p class="conclusion">所有异常都继承自 <code>Throwable</code>。了解类型有助于选择合适的处理策略。</p>
            </div>
        </section>

        <!-- Slide 4: Checked vs Unchecked -->
        <section class="slide">
            <div class="slide-content">
                <h2>Checked vs Unchecked 异常</h2>
                <img src="images/6-4-unchecked-exception.png" alt="Checked vs Unchecked" style="width: 75%; margin: 15px auto;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div>
                        <h4 style="color: #f39c12;">Checked Exceptions</h4>
                        <ul>
                            <li>编译器强制处理</li>
                            <li>可预期的外部问题</li>
                            <li>必须捕获或声明throws</li>
                            <li>示例：IOException, SQLException</li>
                        </ul>
                    </div>
                    <div>
                        <h4 style="color: #3498db;">Unchecked Exceptions</h4>
                        <ul>
                            <li>编译器不强制处理</li>
                            <li>程序逻辑错误</li>
                            <li>可通过编码避免</li>
                            <li>示例：NullPointerException, IndexOutOfBoundsException</li>
                        </ul>
                    </div>
                </div>
                <p class="conclusion">"check"指的是编译器检查。Checked异常是契约，Unchecked是提醒。</p>
            </div>
        </section>

        <!-- 第二部分：异常处理实践 -->

        <!-- Slide 5: Throwing Exceptions -->
        <section class="slide">
            <div class="slide-content">
                <h2>抛出异常：及时失败</h2>
                <p>当检测到非法参数或状态时，立即抛出异常并提供清晰的错误信息。</p>
                <pre><code class="language-java">public static int divide(int a, int b) {
    if (b == 0) {
        throw new IllegalArgumentException("被除数不能为 0");
    }
    return a / b;
}

public void processAge(int age) {
    if (age < 0 || age > 150) {
        throw new IllegalArgumentException("年龄必须在 0-150 之间，当前：" + age);
    }
    // 处理逻辑
}</code></pre>
                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <p><strong>最佳实践：</strong></p>
                    <ul>
                        <li>抛出最具体的异常类型</li>
                        <li>提供清晰、有用的错误消息</li>
                        <li>在问题源头及时抛出</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Slide 6: Method Declaration with throws -->
        <section class="slide">
            <div class="slide-content">
                <h2>方法声明：throws 契约</h2>
                <p>当方法可能抛出Checked异常时，必须在方法签名中声明。</p>
                <pre><code class="language-java">// 文件读取方法
public String readFile(String filename) throws IOException {
    return Files.readString(Paths.get(filename));
}

// 网络请求方法
public void sendRequest(String url) throws IOException, TimeoutException {
    // 网络操作代码
}

// 多个异常声明
public void process() throws IOException, SQLException, ParseException {
    // 可能抛出多种异常的操作
}</code></pre>
                <p class="conclusion"><code>throws</code> 为调用者提供明确契约：该方法可能失败，调用者必须处理。</p>
            </div>
        </section>

        <!-- Slide 7: Catching Exceptions -->
        <section class="slide">
            <div class="slide-content">
                <h2>捕获异常：try-catch</h2>
                <img src="images/6-4-how-to-use-exception.png" alt="使用异常的建议" style="width: 70%; margin: 15px auto;">
                <pre><code class="language-java">public static void main(String[] args) {
    try {
        // 可能出现异常的代码
        String content = readFile("data.txt");
        System.out.println(content);
    } catch (IOException e) {
        // 处理异常
        System.err.println("文件读取失败：" + e.getMessage());
        logger.error("文件操作异常", e);
    }
    System.out.println("程序继续执行...");
}</code></pre>
                <div style="background: #fff3cd; padding: 10px; border-radius: 5px;">
                    <p><strong>⚠️ 避免空的 catch 块</strong> - 这会"吞掉"异常，让调试变得困难</p>
                </div>
            </div>
        </section>

        <!-- Slide 8: Multiple Catch -->
        <section class="slide">
            <div class="slide-content">
                <h2>多重捕获与父子类顺序</h2>
                <p>异常捕获必须<strong>从具体到一般</strong>排列，否则编译错误！</p>

                <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h4 style="color: #856404; margin-top: 0;">⚠️ 编译错误示例</h4>
                    <pre><code class="language-java">try {
    processData();
} catch (IOException e) {        // ❌ 父类在前
    System.out.println("IO错误：" + e.getMessage());
} catch (FileNotFoundException e) { // ❌ 子类在后 - 编译错误！
    System.out.println("文件不存在：" + e.getMessage());
}</code></pre>
                    <p><strong>错误原因：</strong>FileNotFoundException 继承自 IOException，父类捕获器会"吞掉"所有子类异常，导致子类捕获器永远无法执行。</p>
                </div>

                <div style="background: #d4edda; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h4 style="color: #155724; margin-top: 0;">✅ 正确顺序示例</h4>
                    <pre><code class="language-java">try {
    processData();
} catch (FileNotFoundException e) {     // ✅ 最具体的子类在前
    System.out.println("文件不存在：" + e.getMessage());
} catch (IOException e) {                // ✅ 父类在后
    System.out.println("其他IO错误：" + e.getMessage());
} catch (Exception e) {                  // ✅ 最通用的父类在最后
    System.out.println("其他错误：" + e.getMessage());
}</code></pre>
                </div>

                <h4>异常继承关系示例</h4>
                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 15px 0;">
                    <code style="font-size: 0.9em;">Exception ← IOException ← FileNotFoundException</code>
                </div>

                <h4>多异常合并（同级别异常）</h4>
                <pre><code class="language-java">// ✅ 可以合并不相关的同级别异常
try {
    processData();
} catch (FileNotFoundException | SocketTimeoutException e) {
    System.out.println("文件或网络错误：" + e.getMessage());
} catch (IOException e) {
    System.out.println("其他IO错误：" + e.getMessage());
}</code></pre>

                <div style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin-top: 20px;">
                    <p><strong>📌 记忆要点：</strong></p>
                    <ul>
                        <li>异常捕获顺序：子类 → 父类 → 祖父类</li>
                        <li>编译器会检查异常的可达性</li>
                        <li>同级别异常可以用 | 符号合并</li>
                        <li>永远把最通用的 Exception 放在最后</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Slide 9: finally Block -->
        <section class="slide">
            <div class="slide-content">
                <h2>finally：资源清理必执行</h2>
                <p>无论是否发生异常，<code>finally</code> 块总会执行，确保资源正确释放。</p>
                <pre><code class="language-java">FileInputStream fis = null;
try {
    fis = new FileInputStream("data.txt");
    // 文件操作
    int data = fis.read();
} catch (IOException e) {
    System.out.println("IO错误：" + e.getMessage());
} finally {
    // 确保文件流被关闭
    if (fis != null) {
        try {
            fis.close();
        } catch (IOException e) {
            System.out.println("关闭文件时出错");
        }
    }
    System.out.println("资源清理完成");
}</code></pre>
                <p class="conclusion">使用 try-with-resources 可以自动处理资源关闭（Java 7+）。</p>
            </div>
        </section>

        <!-- Slide 10: Exception Propagation -->
        <section class="slide">
            <div class="slide-content">
                <h2>异常传播：rethrow</h2>
                <p>在当前层无法或不想处理异常时，可以将其传播给上层调用者。</p>
                <pre><code class="language-java">// 方法1：直接传播
public void readConfig() throws IOException {
    String content = Files.readString(Paths.get("config.json"));
    processConfig(content);
}

// 方法2：处理后传播
public void loadData() {
    try {
        readConfig();
    } catch (IOException e) {
        // 记录日志
        logger.error("配置加载失败", e);
        // 继续向上传播
        throw new RuntimeException("系统配置异常", e);
    }
}</code></pre>
                <p class="conclusion">合理的异常传播能让"最了解上下文"的层来处理问题。</p>
            </div>
        </section>

        <!-- Slide 11: Complete Exception Handling Flow -->
        <section class="slide">
            <div class="slide-content">
                <h2>完整异常处理流程</h2>
                <pre><code class="language-java">public class FileProcessor {
    public void processFile(String filename) {
        try {
            String content = readFile(filename);
            String result = transform(content);
            saveResult(result);
            System.out.println("处理完成");
        } catch (FileNotFoundException e) {
            System.out.println("文件不存在，请检查路径：" + filename);
        } catch (IOException e) {
            System.out.println("文件操作失败：" + e.getMessage());
            logger.error("IO异常", e);
        } catch (DataFormatException e) {
            System.out.println("数据格式错误：" + e.getMessage());
        } catch (Exception e) {
            System.out.println("未知错误：" + e.getMessage());
            logger.error("处理异常", e);
        } finally {
            cleanup();
        }
    }
}</code></pre>
                <p class="conclusion">完整的异常处理包括：分类处理、日志记录、用户提示、资源清理。</p>
            </div>
        </section>

        <!-- 第三部分：高级技巧 -->

        <!-- Slide 12: Custom Exceptions -->
        <section class="slide">
            <div class="slide-content">
                <h2>自定义异常</h2>
                <p>根据业务需求定义专门的异常类型，提供更精确的错误信息。</p>
                <pre><code class="language-java">// 业务异常（Checked）
public class BusinessException extends Exception {
    private final int errorCode;

    public BusinessException(int errorCode, String message) {
        super(message);
        this.errorCode = errorCode;
    }

    public int getErrorCode() { return errorCode; }
}

// 业务运行时异常（Unchecked）
public class BusinessException extends RuntimeException {
    public BusinessException(String message) {
        super(message);
    }
}

// 使用示例
public void withdraw(double amount) throws BusinessException {
    if (amount > balance) {
        throw new BusinessException(1001, "余额不足");
    }
    balance -= amount;
}</code></pre>
                <p class="conclusion">自定义异常让错误处理更精确，便于分类和统计。</p>
            </div>
        </section>

        <!-- Slide 13: Exception Handling Best Practices -->
        <section class="slide">
            <div class="slide-content">
                <h2>异常处理最佳实践</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: #27ae60;">✅ 推荐做法</h4>
                        <ul>
                            <li>具体异常类型优先</li>
                            <li>有意义的错误消息</li>
                            <li>记录详细日志</li>
                            <li>及时释放资源</li>
                            <li>提供用户友好提示</li>
                            <li>异常链传递</li>
                        </ul>
                    </div>
                    <div>
                        <h4 style="color: #e74c3c;">❌ 避免做法</h4>
                        <ul>
                            <li>空的catch块</li>
                            <li>捕获Exception过于宽泛</li>
                            <li>忽略异常信息</li>
                            <li>异常中返回正常值</li>
                            <li>长时间不处理异常</li>
                            <li>异常用于流程控制</li>
                        </ul>
                    </div>
                </div>
                <div style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin-top: 20px;">
                    <p><strong>黄金法则：</strong>异常应该用于处理异常情况，不应该用作正常的程序流程控制。</p>
                </div>
            </div>
        </section>

        <!-- Slide 14: Real-world Example -->
        <section class="slide">
            <div class="slide-content">
                <h2>实战案例：用户注册系统</h2>
                <pre><code class="language-java">public class UserService {
    public void register(User user) throws UserException {
        try {
            // 参数验证
            if (user.getEmail() == null || !isValidEmail(user.getEmail())) {
                throw new ValidationException("邮箱格式不正确");
            }

            // 检查重复
            if (userDao.existsByEmail(user.getEmail())) {
                throw new DuplicateException("邮箱已被注册");
            }

            // 保存用户
            userDao.save(user);
            sendWelcomeEmail(user);

        } catch (DatabaseException e) {
            logger.error("数据库操作失败", e);
            throw new UserException("注册失败，请稍后重试", e);
        } catch (EmailException e) {
            logger.warn("欢迎邮件发送失败", e);
            // 注册成功，邮件失败不影响主流程
        }
    }
}</code></pre>
                <p class="conclusion">实际项目中，异常处理要平衡用户体验、系统稳定性和开发效率。</p>
            </div>
        </section>

        <!-- 第四部分：补充知识 -->

        <!-- Slide 15: Assertions -->
        <section class="slide">
            <div class="slide-content">
                <h2>断言：开发阶段的检查</h2>
                <p>断言用于在开发和测试阶段验证程序的不变量，失败时抛出 <code>AssertionError</code>。</p>
                <pre><code class="language-java">public class Calculator {
    public double divide(int a, int b) {
        // 断言：除数不能为0（开发阶段检查）
        assert b != 0 : "除数不能为0";
        return (double) a / b;
    }

    public void processAge(int age) {
        // 断言：年龄必须在合理范围内
        assert age >= 0 && age <= 150 : "年龄超出合理范围：" + age;
        // 处理逻辑
    }
}

// 启用断言编译和运行
// javac -ea Calculator.java
// java -ea Calculator</code></pre>
                <div style="background: #fff3cd; padding: 10px; border-radius: 5px;">
                    <p><strong>注意：</strong>断言默认关闭，仅用于开发测试。生产环境应使用参数验证和异常处理。<br>IDEA 中，需要右键点击edit Main.main() 然后再vm option中填入 -ea
</p>
                </div>
            </div>
        </section>

        <!-- Slide 16: Summary -->
        <section class="slide">
            <div class="slide-content">
                <h2>总结与学习建议</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3>核心概念</h3>
                        <ul>
                            <li>异常分类：Error vs Exception</li>
                            <li>Checked vs Unchecked</li>
                            <li>异常处理：try-catch-finally</li>
                            <li>异常传播：throws & rethrow</li>
                        </ul>
                    </div>
                    <div>
                        <h3>实践技能</h3>
                        <ul>
                            <li>选择合适的异常类型</li>
                            <li>编写清晰的错误消息</li>
                            <li>正确的资源管理</li>
                            <li>异常处理的最佳实践</li>
                        </ul>
                    </div>
                </div>

                <h3>练习项目</h3>
                <ol>
                    <li><strong>文件处理工具</strong>：实现文件复制、移动功能，处理各种IO异常</li>
                    <li><strong>计算器程序</strong>：支持各种运算，处理除零、格式等异常</li>
                    <li><strong>用户管理系统</strong>：注册、登录功能，完整的异常处理机制</li>
                </ol>

                <p class="conclusion">异常处理是编写健壮程序的关键技能。记住：异常用于异常情况，不要用作正常流程控制。</p>
            </div>
        </section>

        <!-- UI Elements -->
        <div class="progress-bar-container">
            <div id="progress-bar"></div>
        </div>
        <div class="controls">
            <button id="prevBtn">上一页</button>
            <span id="slide-counter">1 / X</span>
            <button id="nextBtn">下一页</button>
        </div>
    </main>

    <script src="../prism/prism.js"></script>
    <script src="../prism/prism-autoloader.min.js"></script>
    <script src="./js/ppt.js"></script>
    <script src="./js/nav.js"></script>
</body>

</html>